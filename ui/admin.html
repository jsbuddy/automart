<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Admin</title>
    <link rel="stylesheet" href="assets/css/elements.min.css">
    <link rel="stylesheet" href="assets/css/utils.min.css">
    <link rel="stylesheet" href="assets/css/layout.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"
        integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <script src="assets/js/auth.js"></script>
    <script>
        Auth.verify(true);
    </script>
</head>

<body class="nav-padding">
    <nav class="navbar">
        <div class="container" id="nav">
            <div class="skeleton first">lorem.</div>
            <div class="flex justify-end">
                <div class="skeleton">Lorem ip.</div>
                <div class="skeleton">Lorem ipsum.</div>
                <div class="skeleton">Lorem.</div>
            </div>
        </div>
    </nav>
    <main>
        <div class="container dashboard">
            <div class="flex justify-between align-center mb-4">
                <div class="tab-items">
                    <div class="tab-item active">All Ads</div>
                    <div class="tab-item">Flagged Ads</div>
                </div>
                <div class="flex align-center">
                    <label class="input-box" style="width: 100px">
                        <select class="control" name="filter">
                            <option value="all">All</option>
                            <option value="sold">Sold</option>
                            <option value="unsold">Unsold</option>
                        </select>
                    </label>
                </div>
            </div>
            <div class="tab-views">
                <div class="tab-view active">
                    <div class="dashboard-items" id="ads">
                        <div class="dashboard-item">
                            <div class="flex justify-between details">
                                <div class="skeleton-children">
                                    <div class="title">Lorem ipsum dolor sit.</div>
                                    <div class="subtitle mt-2">Lorem ipsum.</div>
                                    <div class="subtitle mt-2">L</div>
                                </div>
                                <div class="right skeleton-children">
                                    <div>Lorem, ipsum.</div>
                                </div>
                            </div>
                            <div class="actions flex skeleton-children">
                                <div class="mr-2">Lorem</div>
                                <div>Lorem</div>
                            </div>
                        </div>
                        <div class="dashboard-item">
                            <div class="flex justify-between details">
                                <div class="skeleton-children">
                                    <div class="title">Lorem ipsum dolor sit.</div>
                                    <div class="subtitle mt-2">Lorem ipsum.</div>
                                    <div class="subtitle mt-2">L</div>
                                </div>
                                <div class="right skeleton-children">
                                    <div>Lorem, ipsum.</div>
                                </div>
                            </div>
                            <div class="actions flex skeleton-children">
                                <div class="mr-2">Lorem</div>
                                <div>Lorem</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-view">
                    <div class="dashboard-items" id="flags">
                        <div class="dashboard-item">
                            <div class="flex justify-between details">
                                <div class="skeleton-children">
                                    <div class="title">L.</div>
                                    <div class="subtitle mt-2">Lorem ipsum dolor sit.</div>
                                    <div class="subtitle mt-2">Lorem ipsum.</div>
                                </div>
                                <div class="right skeleton-children">
                                    <div>Lorem, ipsum.</div>
                                </div>
                            </div>
                            <div class="actions flex skeleton-children">
                                <div>Lorem</div>
                                <div class="ml-2">Lorem</div>
                            </div>
                        </div>
                        <div class="dashboard-item">
                            <div class="flex justify-between details">
                                <div class="skeleton-children">
                                    <div class="title">L.</div>
                                    <div class="subtitle mt-2">Lorem ipsum dolor sit.</div>
                                    <div class="subtitle mt-2">Lorem ipsum.</div>
                                </div>
                                <div class="right skeleton-children">
                                    <div>Lorem, ipsum.</div>
                                </div>
                            </div>
                            <div class="actions flex skeleton-children">
                                <div>Lorem</div>
                                <div class="ml-2">Lorem</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="deleteModal">
        <div class="card">
            <div class="card-body">
                <div class="title mb-4">
                    Confirm Delete
                </div>
                <p>Are you sure you want to delete this ad, please note all orders and flags associated with this ad
                    will also be deleted</p>
                <div class="flex justify-end mt-4">
                    <button class="btn sm red outline mr-2" id="confirmDelete">Delete</button>
                    <button class="btn sm red minimal trigger-close" id="cancelDelete">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/api.js"></script>
    <script src="assets/js/modal.js"></script>
    <script src="assets/js/tab.js"></script>
    <script src="assets/js/helpers.js"></script>
    <script src="assets/js/dropdown.js"></script>
    <script>
        // Elements
        const adsWrapper = document.getElementById('ads');
        const flagsWrapper = document.getElementById('flags');
        const confirmDelete = document.getElementById('confirmDelete');
        const cancelDelete = document.getElementById('cancelDelete');
        // Modals
        const deleteCarModal = new ModalController(document.getElementById('deleteModal'));
        // Data
        let cars = [];
        let flags = [];

        function populateCars(cars) {
            if (!cars.length) {
                adsWrapper.innerHTML = `
            <div class="dashboard-item">
                <div class="empty">
                    <div class="icon"><i class="fa fa-meh-blank"></i></div>
                    <div class="text">No ad available.</div>
                </div>
            </div>
        `;
                return;
            }

            adsWrapper.innerHTML = cars.map(car => `
        <div class="dashboard-item">
            <div class="details flex justify-between">
                <div>
                    <div class="title">${car.manufacturer} ${car.model} - ${car.state}</div>
                    <div class="subtitle">&#8358;${car.price.toLocaleString()}</div>
                    <div class="seller flex justify-between mt-2">
                        <div class="name flex align-center"><i class="fa fa-user-circle mr-1"></i>${car.owner.firstName} ${car.owner.lastName}</div>
                    </div>
                </div>
                <div class="right">
                    ${car.status === 'sold' ? `<div class="chip green">Sold</div>` : ''}
                    ${car.status === 'available' ? `<div class="chip blue">Available</div>` : ''}
                </div>
            </div>
            <div class="actions flex justify-between">
                <div>
                    <a href="car.html?id=${car.id}" class="btn primary sm outline">View</a>
                    <button class="btn primary sm outline red" id="deleteCarModalTrigger" data-id="${car.id}">
                        Delete
                    </button>
                </div>
                <div class="right">
                </div>
            </div>
        </div>
    `).join('');
        }

        function populateFlags(flags) {
            if (!flags.length) {
                flagsWrapper.innerHTML = `
            <div class="dashboard-item">
                <div class="empty">
                    <div class="icon"><i class="fa fa-meh-blank"></i></div>
                    <div class="text">No flagged vehicle.</div>
                </div>
            </div>
        `;
                return;
            }

            flagsWrapper.innerHTML = flags.map(flag => `
        <div class="dashboard-item">
            <div class="details flex justify-between">
                <div>
                    <div class="seller flex justify-between">
                        <div class="name flex align-center">
                            <i class="fa fa-user-circle mr-1"></i>${flag.creator.firstName} ${flag.creator.lastName}&nbsp;
                            <span class="text-italic" style="font-style: italic">on ${formatDate((flag.createdAt))}</span>
                        </div>
                    </div>
                    <div class="title mt-2">${flag.car.manufacturer} ${flag.car.model} - &#8358;${flag.car.price.toLocaleString()}</div>
                    <div class="subtitle">Reason: ${capitalize(flag.reason)}</div>
                    <div class="subtitle">Description: ${flag.description}</div>
                </div>
                <div class="right">
                    ${flag.car.status === 'sold' ? `<div class="chip green">Sold</div>` : ''}
                    ${flag.car.status === 'available' ? `<div class="chip blue">Available</div>` : ''}
                    <div class="chip blue">${capitalize(flag.car.state)}</div>
                </div>
            </div>
            <div class="actions flex justify-between">
                <div>
                    <a href="car.html?id=${flag.car.id}" class="btn primary sm outline">View</a>
                    <button class="btn primary sm outline red" id="deleteCarModalTrigger" data-id="${flag.car.id}">
                        Delete
                    </button>
                </div>
                <div class="right">
                </div>
            </div>
        </div>
    `).join('');
        }

        function removeCar(id) {
            cars = cars.reduce((_cars, car) => {
                if (car.id !== id) _cars.push(car);
                return _cars;
            }, []);
            populateCars(cars);
        }

        async function deleteCar() {
            confirmDelete.disabled = true;
            cancelDelete.disabled = true;
            const deleted = await Api.deleteCar(current);
            confirmDelete.disabled = false;
            cancelDelete.disabled = false;
            if (deleted) {
                removeCar(current);
                deleteCarModal.close();
            }
        }

        async function init() {
            [cars, flags] = await Promise.all([Api.getAllCars(), Api.getFlags()]);
            populateCars(cars);
            populateFlags(flags);
        }

        init();

        window.addEventListener('click', async (e) => {
            if (e.target.id === 'deleteCarModalTrigger') {
                current = e.target.dataset.id;
                deleteCarModal.show();
            }
        });

        confirmDelete.addEventListener('click', deleteCar)
        cancelDelete.addEventListener('click', deleteCarModal.close());
    </script>
</body>

</html>